## 5.7 Persistence Mechanisms

To ensure **persistent access to the compromised machine** even after reboot or user change, two **independent persistence mechanisms** were implemented.

The first one was a **scheduled task (`schtasks`)** running with **SYSTEM privileges**.  
A system task was created to **automatically launch the Apollo agent** at every user logon, regardless of the user's privilege level.  
Thanks to the `/ru SYSTEM` parameter, this process runs in the **SYSTEM account context**, which has **higher privileges than a regular Administrator**:

```powershell
schtasks /create /tn "WinUpdateMal" 
/tr "powershell.exe -WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -Command Start-Process 'C:∖Users\Public\Downloads\update_service_Mal.exe' -WindowStyle Hidden" 
/sc onlogon /ru "SYSTEM" /rl highest /f
```

The second mechanism was **adding a registry entry**.  
Using the graphical interface (**Registry Editor — regedit**), an entry was created in the **HKLM registry hive** to **launch the payload with regular user privileges at every system startup**.  
This was done by navigating to:

`HKLM\Software\Microsoft\Windows\CurrentVersion\Run`

A new string value named `WinUpdateMALK` was created and assigned a command to **launch the payload in a hidden window**:

```powershell
powershell.exe -WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass `
-Command Start-Process "C:∖Users\Public\Downloads\update_service_Mal.exe" -WindowStyle Hidden
```

As a result, **two independent Apollo callbacks are launched at every user logon** —  
one running with **SYSTEM privileges**, and the other running in the **context of the logged-in user**.

In practice, these two callbacks are **functionally complementary**:
- the **SYSTEM session** has **extended capabilities for modifying the system and registry**,  
- while the **user session** allows actions such as **capturing screenshots**, which is not possible from the SYSTEM context (it has no access to the graphical interface of the active user session).

This approach ensures **full flexibility and effectiveness of post-exploitation activities** in the later stages of the attack.
